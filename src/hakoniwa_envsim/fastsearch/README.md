# FastSearcher

**FastSearcher** は、環境空間（AABB群）を階層的に分割し、  
高速な位置検索を実現するための空間インデックスライブラリです。  

このモジュールは、**理論モデル・実装構造・実測検証**が一体化しており、  
シミュレーション環境における空間探索の高速化基盤を提供します。

---

## 🌳 構成

| モジュール | 役割 |
|-------------|------|
| `builder.py` | AABBの階層構造（BVH）を構築 |
| `estimator.py` | 探索コストを理論的に推定 |
| `analysis.py` | 実際のツリー構造を解析（リーフ数や深さ） |
| `test.py` | 実データを用いた検証スクリプト |

---

## ⚙️ アルゴリズム概要

### 1. BVH構築 (`build_bvh`)
- 最も広がりのある軸を選択  
- その軸でソートして2分割  
- 再帰的に階層構造を構築  

→ 空間的に近いAABBを同じ枝にまとめることで、探索を最小化。

---

### 2. 理論探索コストの推定 (`estimate_cost`)
理論モデル：

$T_{\text{est}} = D \times \left(1 + \frac{\log_2(b)}{4}\right)$

| 記号 | 意味 |
|------|------|
| $D$ | 階層の深さ（max_depth） |
| $b = N^{1/D}$ | 平均分割幅（branch_factor） |
| $N$ | 総AABB数 |

- 木の深さが深いほど探索階層が増えるが、リーフサイズは減少。
- $log2(b)/4$ は分岐による軽いオーバーヘッド補正。

---

### 3. 実測探索コストの解析 (`analyze_tree`)
実際のツリーを走査して、  
- `max_depth`: 実際の深さ  
- `avg_leaf_size`: 平均リーフあたりAABB数  

を算出し、探索コストを次式で評価：


$T_{\text{real}} \approx D + \text{avg\_leaf\_size}$

---

## 🧪 実行方法

```bash
python -m fastsearch.test <area.json> [max_depth]
```

例：
```
python -m fastsearch.test ../../examples/datasets/kobe/generated/area.json 8
```

出力例：
```
📘 理論推定: {'num_areas': 704, 'max_depth': 8, 'estimated_branch_factor': 2.27, 'estimated_max_search_cost': 10.36}
🌳 実際のツリー解析: {'max_depth': 8, 'avg_leaf_size': 2.75}
```


---

## 📈 理論と実測の比較（Kobe Dataset）

| Depth (D) | Branch Factor (b) | 理論コスト (T_est) | 平均リーフ数 (avg_leaf_size) | 実測コスト (D+avg_leaf_size) |
| --------- | ----------------- | ------------- | ---------------------- | ----------------------- |
| 5         | 3.711             | 7.36          | 22.0                   | 27.0                    |
| 6         | 2.983             | 8.36          | 11.0                   | 17.0                    |
| 7         | 2.552             | 9.36          | 5.5                    | 12.5                    |
| 8         | 2.270             | 10.36         | 2.75                   | 10.75                   |
| 9         | 2.072             | 11.36         | 1.38                   | 10.38                   |

✅ 深さを増やすとリーフ数が指数的に減少し、
探索コストは ( D + \text{avg_leaf_size} ) で最小点（D≈8付近）を取る。
→ 理論と実測がほぼ一致。

---

## 🔍 数式対応関係

| 概念       | たかし式（直感モデル）   | estimator式（近似モデル）                |
| -------- | ------------- | -------------------------------- |
| 分割幅      | ( b )         | $num\_areas ** (1.0 / max\_depth)$ |
| 探索深さ     | ( D )         | $max\_depth$                      |
| リーフ探索コスト | ( N/b^D )     | $log2(b)/4$（滑らかな近似）              |
| 総コスト     | ( D + N/b^D ) | $D * (1 + log2(b)/4)$            |

---

